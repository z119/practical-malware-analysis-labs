<!DOCTYPE html>
<html>
	<head>
		<title>Lab01-01</title>
			<meta name="description" content="Solutions to Lab01-01 from the book Practical Malware Analysis" />
			<meta name="keywords" content="Malware, solutions, labs" />
		
		<style>
			h1.TitleName
			{
				text-align:center;
				font-family:Roman New Times;
			}
			
			.grid-container {
				display: inline-grid;
				grid-template-columns: auto auto auto;
				background-color: white;
				padding: 1px;
			}
			.grid-item {
				background-color: white;
				border: 1px solid black;
				padding: 5px;
				font-size: 15px;
				text-align: left;
			}
			
			.grid-container-2 {
				display: inline-grid;
				grid-template-columns: auto auto;
				background-color: white;
				padding: 1px;
			}
			.grid-item-2 {
				background-color: white;
				border: 1px solid black;
				padding: 5px;
				font-size: 15px;
				text-align: left;
			}
		</style>
	</head>
	
	<body>
			<body style="font-family:Roman New Times">
			<h1 class="TitleName"><i>Chapter One</i></h1>
			
					<h4 style="text-align:center">
						<p>Lab01-01.exe & Lab01-01.dll</p>
						<p>The following are the results from a static analysis of <i>Lab01-01.exe</i> and <i>Lab01-01.dll</i> from the book <i>Practical Malware Analysis.</i></p>
					</h4>

						<p><i>Lab01-01.exe</i></p>
						
						<p>The file <i>Lab01-01.exe</i> was uploaded to <a href="http://www.VirusTotal.com/.">http://www.VirusTotal.com.</a></p> 
						<p>The upload produced 40 engines which detected the file. <a href=https://www.virustotal.com/gui/file/58898bd42c5bd3bf9b1389f0eee5b39cd59180e8370eb9ea838a0b327bd6fe47/detection>https://www.virustotal.com/gui/file/58898bd42c5bd3bf9b1389f0eee5b39cd59180e8370eb9ea838a0b327bd6fe47/detection</a></p>

						<p>PEView finder reports that this file was compiled on 12/19/2010 @ 16:16:19 UTC</p>

						<p><i>Lab01-01.exe</i> appears not to be a packed or obfuscated file.  This is indicated by:</p>
						<p>&nbsp&nbsp&nbsp&nbsp1). the minimal difference between its virtual size and size of raw data.</p>
						<p>&nbsp&nbsp&nbsp&nbsp2). The number of strings / functions given during static analysis.</tabindex></p>
						
						
							<div class = "grid-container">
								<div class="grid-item">Section</div>
								<div class="grid-item">Virtual Size</div>
								<div class="grid-item">Size of raw data</div>
								<div class="grid-item">.text</div>
								<div class="grid-item">970</div>
								<div class="grid-item">1000</div>
								<div class="grid-item">.data</div>
								<div class="grid-item">FC</div>
								<div class="grid-item">1000</div>
								<div class="grid-item">.rdata</div>
								<div class="grid-item">2B2</div>
								<div class="grid-item">1000</div>
							</div>
								
						<p>A listing of strings were extracted from the file. Interesting to note the comparison of the highlighted strings, where the difference between the two are the number “1” and the letter “l”:</p>
						<h3><p>Display 1.1.1</p></h3>
						<img src="Chapter_1.1_jpgs/Display 1.1.1.jpg" alt="Listing of strings" width="700" height="450">
						
						<h43<p>Imports:</p></h3>
						
						<div class = "grid-container-2">
								<div class="grid-item-2">KERNEL32.dll</div>
								<div class="grid-item-2">Intention</div>
								<div class="grid-item-2">MapViewOfFile</div>
								<div class="grid-item-2">Maps a view of a file mapping into the address space of a calling process</div>
								<div class="grid-item-2">UnmapViewOfFile</div>
								<div class="grid-item-2">Unmaps a mapped view of a file</div>
								<div class="grid-item-2">FindFirstFileA</div>
								<div class="grid-item-2">Searches a directory for a file or subdirectory with a name that matches a specific name</div>
								<div class="grid-item-2">FindNextFileA</div>
								<div class="grid-item-2">Continues a file search from a previous call to the FindFirstFileA</div>
								<div class="grid-item-2">FindClose</div>
								<div class="grid-item-2">Closes a file search handle opened by FindFirstFileA</div>
								<div class="grid-item-2">CopyFileA</div>
								<div class="grid-item-2">Copies an existing file to a new file</div>
								<div class="grid-item-2">CloseHandle</div>
								<div class="grid-item-2">Closes an open object handle</div>
								<div class="grid-item-2">CreateFileMappingA</div>
								<div class="grid-item-2">Creates or opens a named or unnamed file mapping object for a specified file</div>
								<div class="grid-item-2">CreateFileA</div>
								<div class="grid-item-2">Creates or opens a file or I/O device, such as file, file stream, directory, console buffer. Returns a handle used to access the file or device. </div>
								<div class="grid-item-2">IsBadReadPtr</div>
								<div class="grid-item-2">Verifies that the calling process has read access to the specified range of memory</div>
							</div>
							
							<p><i>Lab01-01.dll</i></p>
							<p>The file <i>Lab01-01.dll</i> was uploaded to <a href="http://www.VirusTotal.com/.">http://www.VirusTotal.com.</a></p> 
							<p><i>Lab01-01.dll</i> found 32 engines which detected the file. <a href=https://www.virustotal.com/gui/file/f50e42c8dfaab649bde0398867e930b86c2a599e8db83b8260393082268f2dba/details>https://www.virustotal.com/gui/file/f50e42c8dfaab649bde0398867e930b86c2a599e8db83b8260393082268f2dba/details</a></p>
							
							<p>PEView finder reports that this file was compiled on 12/19/2010 @ 16:16:38 UTC.</p>

							<p>A listing of strings were extracted from <i>Lab01-01.dll</i>. This shows us various components: functions, dlls, an IP address, and a string that’s difficult to interpret:</p>
							<h4><p>Display 1.1.2</p></h4>
							<img src="Chapter_1.1_jpgs/Display 1.1.2.jpg" alt="Listing of strings">
							
							<p><i>Lab01-01.dll</i> appears not to be a packed or obfuscated file.  This is indicated by:</p>
							<p>&nbsp&nbsp&nbsp&nbsp1). the minimal difference between its virtual size and size of raw data.</p>
							<p>&nbsp&nbsp&nbsp&nbsp2). The number of strings / functions given during static analysis.</tabindex></p>
							
							<div class = "grid-container">
								<div class="grid-item">Section</div>
								<div class="grid-item">Virtual Size</div>
								<div class="grid-item">Size of raw data</div>
								<div class="grid-item">.text</div>
								<div class="grid-item">39E</div>
								<div class="grid-item">1000</div>
								<div class="grid-item">.data</div>
								<div class="grid-item">6C</div>
								<div class="grid-item">1000</div>
								<div class="grid-item">.rdata</div>
								<div class="grid-item">23FC6</div>
								<div class="grid-item">24000</div>
								<div class="grid-item">.reloc</div>
								<div class="grid-item">204</div>
								<div class="grid-item">1000</div>
							</div>
							
							<h3><p>Imports:</p></h3>
						
						<div class = "grid-container-2">
								<div class="grid-item-2">KERNEL32.dll</div>
								<div class="grid-item-2">Intention</div>
								<div class="grid-item-2">OpenMutexA</div>
								<div class="grid-item-2">Opens an existing named mutex object</div>
								<div class="grid-item-2">CreateMutexA</div>
								<div class="grid-item-2">Creates or opens a named or unamed mutex object</div>
								<div class="grid-item-2">Sleep</div>
								<div class="grid-item-2">Suspends the execution of a current thread until the time-out interval elapses</div>
								<div class="grid-item-2">CloseHandle</div>
								<div class="grid-item-2">Closes an open object handle</div>
								<div class="grid-item-2">CreateProcessA</div>
								<div class="grid-item-2">Creates a new process and its primary thread.</div>
						</div>
								
						<div class = "grid-container-2">
								<div class="grid-item-2">WS2_32.dll</div>
								<div class="grid-item-2">Intention</div>
								<div class="grid-item-2">socket</div>
								<div class="grid-item-2">Creates a socket that is bound to a specific transport service provider</div>
								<div class="grid-item-2">closesocket</div>
								<div class="grid-item-2">Closes an existing socket</div>
								<div class="grid-item-2">Inet_addr</div>
								<div class="grid-item-2">Converts a string containing an IPv4 dotted-decimal address into a proper address for the IN_ADDR structure</div>
								<div class="grid-item-2">send</div>
								<div class="grid-item-2">The send function sends data on a connected socket</div>
								<div class="grid-item-2">WSACleanup</div>
								<div class="grid-item-2">The WSACleanup function terminates use of the Winsock 2 DLL (Ws2_32.dll)</div>
								<div class="grid-item-2">WSAStartup</div>
								<div class="grid-item-2">The WSAStartup function initiates use of the Winsock DLL by a process</div>
								<div class="grid-item-2">Connect</div>
								<div class="grid-item-2">Establishes a connection to a specified socket</div>
								<div class="grid-item-2">Shutdown</div>
								<div class="grid-item-2">Disables sends or receives on a socket</div>
								<div class="grid-item-2">Htons</div>
								<div class="grid-item-2">Converts a u_short from host to TCP/IP network byte order (which is big-endian)</div>
								<div class="grid-item-2">recv</div>
								<div class="grid-item-2">Receives data from a connected socket or a bound connectionless socket</div>
							</div>
							
						<p>It seems the function of the <i>Lab01-01.exe</i> is working in conjunction with <i>Lab01-01.dll</i>.</p>
						<p>Both were created on the same date and around the same time. Display 1.1.3 shows that <i>Lab01-01.exe</i> is mapping for a file: <i>C:\\Windows\\System32\\Kernel32.dll</i> to be exact.</p>
						<h3><p>Display 1.1.3</p></h3>
						<img src="Chapter_1.1_jpgs/Display 1.1.3.jpg" alt="Mapping for a file" width="900" height="650">
						
						<p>This shows that once the file is located, it will be overwritten with <i>Lab01-01.dll</i>, but given a new file name <i>C:\\Windows\\System32\\Kerne132.dll</i> (the l in kernel is replaced with the digit 1). 
						<h4><p>Display 1.1.4</p></h4>
						<img src="Chapter_1.1_jpgs/Display 1.1.4.jpg" alt="Showing a file overwrite" width="900" height="650">
						
						<p>Once created on the user system, <i>Lab01-01.dll</i> appears to be used to create an internet connection, shown by various WS2_32.dll functions <i>socket</i>, <i>closesocket</i>, <i>inet_addr</i>, <i>send</i>, etc. 
						   This would allow the program to create a foothold within the user’s system and dispense and receive instructions.</p>
						
						<h3 style="text-align:center">
						<p><i>Summary</i></p>
						</h3>
						
						<p>Static analysis indicates that one of the mechanisms of attack of <i>Lab01-01.exe</i> and <i>Lab01-01.dll</i> include 
						   manipulating data structures and system resources, namely through an alternative execution due to a deceptive 
						   filename. In this case, it was by converting “kernel32.dll” to “kerne132.dll”. This could be later completed in 
						   order to execute malicious code or expose sensitive information.</p>
						   
						<p>A prerequisite for the use of this file is that it must be controlled by the file extension. To mitigate this, 
						   applications should verify that the content of the file is in alignment with the format it is expecting, and not to 
						   depend entirely on the file extension [1].</p>

						<p>[1].CAPEC. https://capec.mitre.org/data/definitions/635.html</p>						
	</body>
</html>
